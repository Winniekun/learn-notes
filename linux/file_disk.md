## Linux文件系统

`EXT2`作为最传统的磁盘文件系统，所以要了解 Linux 的文件系统，就要先由 EXT2 开始，而文件系统是建立在磁盘上面的，因此我们得了解磁盘的物理组成才行

## 磁盘组成与分区的复习

### 磁盘组成

磁盘的组成主要有：

- 圆形的磁盘（主要记录数据的部分）
- 机械手臂，与机械手臂上的磁盘读取头（可擦写磁盘上的数据）
- 主轴马达，可以转动磁盘，让机械手臂的读取头在磁盘上读写数据

数据存储与读取的重点在于磁盘，那么磁盘上的物理组成则为（假设为单盘片）：

- 扇区（Sector）为最小的物理存储单位，且依据磁盘设计的不同，目前主要有512bytes与4k两种格式
- 将扇区组成一个圆，那就是磁柱（Cylinder）
- 早期的分区主要以磁柱为最小单位，现在的分区通常使用扇区为最小分区单位（每个扇区都有其号码）
- 磁盘分区表主要有两种格式：

  - MBR 分区表：限制较多
  - GPT 分区表：新的限制较少
- MBR 分区表中，第一个扇区很重要，里面主要有：

  1. 主要开机区（Master boot record ，MBR），占用 446bytes
  2. 分区表（partition table），占用 64bytes

- GPT 分区表除了分区数量扩充较多外，支持的磁盘容量也可以超过2TB

磁盘文件名部分，所有实体磁盘的文件名都已经被模拟成 `/dev/sd[a-p]` 的格式，
磁盘文件名为 /dev/sda。而分区槽则为 `/dev/sda[1-128]`（以第一颗磁盘为例）。

虚拟持平通常为  `/dev/vd[a-p]` 格式。如有使用到软件磁盘阵列的话，还有 `/dev/md[0-128]` 的磁盘文件名。使用的是 LVM 时，则为 `/dev/VGNAME/LVNAME` 等格式。

关于磁盘阵列与 LVM 后面会继续介绍，这里主要介绍以实体磁盘及虚拟磁盘为主。

- `/dev/sd/[a-p][1-128]`：为实体磁盘的磁盘文件名
- `/dev/vd/[a-d][1-128]`：为虚拟磁盘的磁盘文件名

### 磁盘分区

GPT 分区表支持大容量的磁盘，小磁盘默认会使用 MBR 的分区，可以使用配置强制使用 GPT 分区表

## 文件系统特性

为什么在分区完成之后需要格式化（format）才能够使用这个文件系统？因为每种操作系统所设定的文件属性、权限不同，为了存放这些文件所需的数据，因此就需要将分区槽进行格式化成操作系统能够利用的「文件系统格式」，windows 使用 FAT16，包括现在的 NTFS 文件系统，Linux 的正统文件系统则为 Ext2（Linux second extended file system，EXT2fs），在默认情况下，windows 操作系统不会认识 linux 的 ext2 的

传统的磁盘与文件系统之应用中，一个分区槽只能被格式化为一个文件系统，所以我们可以称之为说一个 filesystem 就是一个 partition。新技术的出现，如 LVM 与 软件磁盘阵列（software raid），这些技术可以将一个分区槽格式化为多个文件系统（如 LVM），也可以将多个分区槽合并成一个文件系统（LVM、RAID）。
所以目前在格式化时已经不再说成针对 partition 来格式化了，通常我们可以称呼一个可被挂载的数据为一个文件系统而不是一个分区槽。

那么文件系统是如何运行的呢？这个和实际的文件数据有关。较新的操作系统**文件数据除了文件实际内容以外，通常还有各种其他的属性，例如Linux操作系统的`文件权限（rwx）`和`文件属性（拥有者、群组、时间参数等）`**。并且在文件系统中，通常会将这两部分内容放到不同的区块中：

- inode
  - 权限与属性，一个文件占用一个inode，同时会记录此文件的数据所在的block号码

- data block
  * 用于记录真实的数据内容，若文件太大的时候， 会占用多个block

- super block

  - 存放整个文件系统的整体信息，包括inode和block的总量、使用量、剩余量，以及文件系统的格式与相关信息等

    

![inode-block的联系](https://cdn.jsdelivr.net/gh/Winniekun/cloudImg@master/uPic/image-20211029163342074.png)

同时以上也是**索引式文件系统**，与此同时还有另外一种的存储形式（FAT格式）

![FAT存储格式](https://cdn.jsdelivr.net/gh/Winniekun/cloudImg@master/uPic/image-20211029163929212.png)

**碎片整理：**

> 主要原因就是文件写入的block过于离散化，然后就会导致读取的性能较低，对于FAT文件系统经常需要碎片整理，对于Ext2/Ext3的文件系统来说，就不需要进行碎片整理了

## Linux 的 Ext2 文件系统（inode）

ext2 就是使用这种 inode 为基础的文件系统，并且文件系统一开始就将 inode 与 block 规划好了，除非重新格式化（或则利用 resize2fs 等指令变更文件系统大小），否则 inode 与 block 固定后就不再变动。当文件系统数据高达数百 GB 时，将所有的 inode 与 block 通通放置在一起很不理智，而且这么多数量的 inode 与 blcok ，不太统一管理。因此 ext2 文件系统在格式化的时候，基本上是分区为多个区块组（block group）的，每个区块群组都有独立的 inode、block、superblock 系统。这样分成一群一群的比较好管理，整个来说 ext2 格式化后有点像下图这样



在整体规划中，**文件系统最前面有一个启动扇区（boot sector）**，这个启动扇区可以安装开机管理程序，这是个非常重要的设计，因为能将不同的开机管理程序安装到个别的文件系统最前端，而不用覆盖整颗磁盘唯一的 MBR，正因为这样才能够制作出多重引导环境每个区块群组（block group）的 6 个主要内容如下



